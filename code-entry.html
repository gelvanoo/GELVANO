<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="icon" type="image/png" href="assets/6546847867645351321321354564687654545343.png">
<title>أدخل كود مستر خالد</title>
<style>
  :root{--g1:#66a6ff;--g2:#89f7fe;--ok:#0f9d58;--err:#d93025;--ink:#222;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0; height:100vh; display:flex; align-items:center; justify-content:center; font-family:Tajawal,Arial; background:linear-gradient(135deg,var(--g1),var(--g2))}
  .card{width:min(92vw,440px); background:#fff; border-radius:16px; padding:28px; box-shadow:0 14px 40px rgba(0,0,0,.18); text-align:center; animation:rise .5s ease both}
  .card h2{margin:0 0 14px; color:var(--ink)}
  .hint{color:var(--muted); margin:0 0 16px; font-size:14px}
  .field{display:flex; gap:10px; margin:10px 0 6px}
  input{flex:1; padding:12px 14px; font-size:16px; border-radius:10px; border:2px solid #e5e7eb; outline:none; transition:.25s; text-transform:uppercase}
  input:focus{border-color:var(--g1); box-shadow:0 0 0 4px rgba(102,166,255,.15)}
  button{flex:0 0 120px; padding:12px; border:none; border-radius:10px; color:#fff; font-size:16px; cursor:pointer; background:linear-gradient(135deg,var(--g1),var(--g2)); box-shadow:0 8px 18px rgba(102,166,255,.35)}
  button:hover{transform:translateY(-1px)}
  button:disabled{opacity:.6; cursor:not-allowed; transform:none; box-shadow:none}
  .msg{min-height:26px; margin-top:8px; font-weight:700}
  .msg.error{color:var(--err)} .msg.success{color:var(--ok)}
  .ban{margin-top:16px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:14px}
  .timer{font-variant-numeric:tabular-nums; font-size:28px; font-weight:700; letter-spacing:.5px; margin-top:6px}
  .progress{width:100%; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:10px}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--g1),var(--g2))}
  .whats{margin-top:10px; font-size:14px} .whats b{direction:ltr}
  @keyframes rise{from{opacity:0; transform:translateY(16px)} to{opacity:1; transform:translateY(0)}}
</style>

<!-- Clerk JS -->
<script
  async
  crossorigin="anonymous"
  data-clerk-publishable-key="pk_test_cHJvbXB0LWNoYW1vaXMtNDAuY2xlcmsuYWNjb3VudHMuZGV2JA"
  src="https://prompt-chamois-40.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
</script>
</head>
<body>

<!-- نموذج إدخال الكود فقط -->
<form id="codeForm" style="max-width:340px;margin:60px auto;padding:22px;background:#fff;border-radius:14px;box-shadow:0 4px 18px #0002;">
  <h2 style="margin-bottom:18px;color:#2563eb;">أدخل كود الشهر الخاص بمستر خالد</h2>
  <input type="text" id="lessonCodeInput" placeholder="كود شهر مستر خالد" style="width:90%;padding:10px;border-radius:7px;border:1px solid #ccc;margin-bottom:12px;">
  <button id="submitBtn" type="submit" style="background:#2563eb;color:#fff;padding:10px 30px;border:none;border-radius:7px;font-size:1.1rem;cursor:pointer;">تحقق</button>
  <div id="lessonMsg" class="msg" style="margin-top:10px;"></div>

  <!-- صندوق الحظر المؤقت -->
  <div id="banBox" class="ban" style="display:none;">
    <div>تم إيقاف المحاولات مؤقتًا بسبب محاولات خاطئة متتالية.</div>
    <div id="timerEl" class="timer">00:00</div>
    <div class="progress"><div id="barEl" class="bar"></div></div>
    <div class="whats">لو محتاج مساعدة تواصل مع الإدارة.</div>
  </div>
</form>

<script>
/* ================== إعدادات عامة ================== */
const API_URL  = "https://68a25cb6c5a31eb7bb1ccafd.mockapi.io/codes";
const NOTIF_URL = "https://68a25cb6c5a31eb7bb1ccafd.mockapi.io/notifications";

const MAX_ATTEMPTS = 5;                 // أقصى عدد محاولات خاطئة قبل الحظر
const BAN_TIME     = 5 * 60 * 1000;     // مدة الحظر (5 دقائق)

// مراجع العناصر
const form   = document.getElementById("codeForm");
const input  = document.getElementById("lessonCodeInput");
const btn    = document.getElementById("submitBtn");
const msg    = document.getElementById("lessonMsg");
const banBox = document.getElementById("banBox");
const timerEl= document.getElementById("timerEl");
const barEl  = document.getElementById("barEl");

// حالة الحظر والمحاولات (من التخزين)
let attempts   = parseInt(localStorage.getItem('codeAttempts') || '0', 10);
let banUntil   = parseInt(localStorage.getItem('codeBanUntil') || '0', 10);
let countdownInterval = null;

/* ================== دوال Clerk ================== */
function getCurrentUserEmail(){
  if (window.Clerk && Clerk.user){
    if (Clerk.user.primaryEmailAddress && Clerk.user.primaryEmailAddress.emailAddress){
      return Clerk.user.primaryEmailAddress.emailAddress;
    } else if (Clerk.user.emailAddresses && Clerk.user.emailAddresses.length > 0) {
      return Clerk.user.emailAddresses[0].emailAddress;
    }
  }
  return "غير معروف";
}

function getCurrentUserId(){
  if (window.Clerk && Clerk.user && Clerk.user.id) {
    return Clerk.user.id;
  }
  return "غير معروف";
}

// جلب اسم المستخدم من Clerk
function getCurrentUsername(){
  if (window.Clerk && Clerk.user && Clerk.user.id) {
    return Clerk.user.firstName || "غير معروف";
  }
  return "غير معروف";
}

/* ================== أدوات الشبكة والأمان ================== */
async function safeFetch(url, opt){
  try {
    const r = await fetch(url, opt);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  } catch(e) {
    throw new Error("فشل الاتصال بالخادم");
  }
}

// إرسال إشعار مخصص مع معالجة الخطأ
// الدالة تقبل أي خصائص إضافية وتضمّن createdAt تلقائيًا
async function sendCustomNotif(payload) {
  try {
    const body = Object.assign({}, payload, { createdAt: new Date().toISOString() });
    await safeFetch(NOTIF_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    });
  } catch(e) {
    msg.className="msg error";
    msg.textContent="⚠️ مشكلة اتصال بالخادم أثناء إرسال الإشعار.";
  }
}

// تشفير وفك تشفير بسيط للكود في localStorage
function encode(str) { return btoa(unescape(encodeURIComponent(str))); }
function decode(str) { try { return decodeURIComponent(escape(atob(str))); } catch(e){ return ""; } }

// تحقق من صحة الكود قبل الإرسال
function isValidCode(code) { return /^[A-Z0-9]{4,10}$/.test(code); }

// منع الهجمات المتكررة (rate limit على العميل)
let lastSubmitTime = 0;
function canSubmit() {
  const now = Date.now();
  if (now - lastSubmitTime < 1500) return false;
  lastSubmitTime = now;
  return true;
}

/* ================== منطق التحقق الرئيسي ================== */
document.getElementById("codeForm").onsubmit = function(e){
  e.preventDefault();
  verifyCode();
};

async function verifyCode(){
  if(!canSubmit()) {
    msg.className="msg error";
    msg.textContent="⚠️ برجاء الانتظار قبل المحاولة مرة أخرى.";
    return;
  }

  // لو في حظر فعّال
  const now=Date.now();
  if(now<banUntil){ setBannedState(true); startCountdown(banUntil); return; }

  // لازم المستخدم يكون مسجل دخول
  if(getCurrentUserEmail() === "غير معروف" || getCurrentUserId() === "غير معروف"){
    msg.className="msg error";
    msg.textContent="⚠️ يجب تسجيل الدخول أولاً.";
    return;
  }

  let inputCode=(input.value||"").trim().toUpperCase();
  if(!isValidCode(inputCode)){
    msg.className="msg error";
    msg.textContent="❌ الكود غير صالح. استخدم حروف وأرقام فقط (4-10).";
    return;
  }

  try{
    const codes = await safeFetch(API_URL);
    const codeObj = Array.isArray(codes) ? codes.find(c=> String(c.code).toUpperCase()===inputCode) : null;

    const userEmail = getCurrentUserEmail();
    const username  = getCurrentUsername();
    const userId    = getCurrentUserId();

    if(!codeObj){
      await sendCustomNotif({
        code: inputCode,
        username,
        userEmail,
        message: `حاول هذا الشخص إدخال كود غير صالح`,
        highlight: false
      });
      return wrongAttempt();
    }

    // لو الكود غير مستخدم → سجلّه لهذا الحساب
    if(!codeObj.isUsed){
      await safeFetch(`${API_URL}/${codeObj.id}`,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          ...codeObj,
          isUsed:true,
          userEmail,
          username,
          userId,
          createdAt: codeObj.createdAt || new Date().toISOString()
        })
      });

      localStorage.setItem("studentCode", encode(codeObj.code));
      localStorage.setItem("studentEmail", encode(userEmail));
      localStorage.setItem("studentUserId", encode(userId));

      await sendCustomNotif({
        code: codeObj.code,
        username,
        userEmail,
        message: `تم تسجيل هذا الكود بنجاح`,
        highlight: true
      });

      msg.className="msg success";
      msg.textContent="✅ تم التسجيل بنجاح";
      setTimeout(()=> location.href="index.html", 800);
      return;
    }

    // الكود مستخدم: لو لنفس الإيميل → دخول
    if(codeObj.userEmail===userEmail){
      localStorage.setItem("studentCode", encode(codeObj.code));
      localStorage.setItem("studentEmail", encode(userEmail));
      localStorage.setItem("studentUserId", encode(userId));
      msg.className="msg success";
      msg.textContent="✅ دخول";
      setTimeout(()=> location.href="index.html", 400);
    }else{
      // محاولة بكود مستخدم لحساب آخر
      await sendCustomNotif({
        code: codeObj.code,
        // بيانات المالك الأول
        ownerUsername: codeObj.username || "غير معروف",
        ownerEmail: codeObj.userEmail || "غير معروف",
        ownerCreatedAt: codeObj.createdAt || null,
        // بيانات المحاول
        attemptUsername: getCurrentUsername() || "غير معروف",
        attemptEmail: getCurrentUserEmail() || "غير معروف",
        attemptUserId: getCurrentUserId() || null,
        message: `حاول هذا الشخص الدخول بكود مستخدم بالفعل`,
        highlight: false
      });
      msg.className="msg error";
      msg.textContent="⚠️ هذا الكود مستخدم من حساب آخر. تواصل مع الإدارة.";
    }
  }catch(e){
    msg.className="msg error";
    msg.textContent="⚠️ السيرفر غير متاح حالياً. حاول لاحقاً.";
  }
}

/* ================== محاولات خاطئة وحظر مؤقت ================== */
async function wrongAttempt(){
  attempts++;
  localStorage.setItem('codeAttempts', String(attempts));
  const remain = MAX_ATTEMPTS - attempts;

  if(attempts>=MAX_ATTEMPTS){
    banUntil = Date.now()+BAN_TIME;
    localStorage.setItem('codeBanUntil', String(banUntil));
    setBannedState(true);
    startCountdown(banUntil);
    msg.className="msg error";
    msg.textContent="تم إيقاف المحاولات مؤقتًا.";
  }else{
    msg.className="msg error";
    msg.textContent=`❌ الكود غير صحيح. تبقى ${remain} محاولات.`;
  }
}

function setBannedState(b){
  input.disabled=b;
  btn.disabled=b;
  banBox.style.display = b ? "block" : "none";
}

function startCountdown(untilTs){
  stopCountdown();
  tick();
  countdownInterval = setInterval(tick,1000);
  function tick(){
    const now=Date.now();
    const remaining=Math.max(0, untilTs-now);
    const m=Math.floor(remaining/60000), s=Math.floor((remaining%60000)/1000);
    timerEl.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    const percent=Math.min(100, Math.max(0,(remaining/BAN_TIME)*100));
    barEl.style.width=`${percent}%`;
    if(remaining<=0){
      clearBan();
      setBannedState(false);
      msg.className="msg";
      msg.textContent="يمكنك المحاولة الآن.";
      stopCountdown();
    }
  }
}
function stopCountdown(){ if(countdownInterval){ clearInterval(countdownInterval); countdownInterval=null; } }
function clearBan(){
  localStorage.removeItem('codeBanUntil');
  banUntil=0;
  attempts=0;
  localStorage.setItem('codeAttempts','0');
}

/* ================== التعامل مع التخزين المحلي ================== */
// عند بدء الصفحة فك تشفير القيم من localStorage إذا وجدت
(function decodeLocalStorage(){
  if(localStorage.getItem("studentCode"))
    localStorage.setItem("studentCode", decode(localStorage.getItem("studentCode")));
  if(localStorage.getItem("studentEmail"))
    localStorage.setItem("studentEmail", decode(localStorage.getItem("studentEmail")));
})();

/* ================== دخول تلقائي إن أمكن ================== */
function clerkReady(callback) {
  let tries = 0;
  function check() {
    if (window.Clerk && window.Clerk.user && window.Clerk.user.id) {
      callback();
    } else if (tries < 80) { // 8 ثواني كحد أقصى
      tries++;
      setTimeout(check, 100);
    }
  }
  check();
}

async function autoRedirectOrShowMsg() {
  clerkReady(async function() {
    let savedCode = localStorage.getItem("studentCode");
    let savedEmail = localStorage.getItem("studentEmail");
    if(savedCode) savedCode = decode(savedCode);
    if(savedEmail) savedEmail = decode(savedEmail);
    const currentEmail = getCurrentUserEmail();

    if(savedCode && savedEmail && currentEmail && savedEmail === currentEmail){
      try {
        const codes = await safeFetch(API_URL);
        const codeObj = Array.isArray(codes) ? codes.find(c=> String(c.code).toUpperCase()===String(savedCode).toUpperCase()) : null;
        if(codeObj && codeObj.isUsed && codeObj.userEmail === currentEmail){
          const created = codeObj.createdAt ? new Date(codeObj.createdAt).getTime() : Date.now();
          const expired = (created + (30*24*60*60*1000)) < Date.now(); // 30 يوم
          if(!expired){
            location.href = "index.html"; // دخول تلقائي
            return;
          } else {
            localStorage.removeItem("studentCode");
            localStorage.removeItem("studentEmail");
          }
        } else {
          localStorage.removeItem("studentCode");
          localStorage.removeItem("studentEmail");
        }
      } catch(e){
        // تجاهل، هيظهر النموذج عادي
      }
    }
  });
}

// تفعيل الحظر عند تحميل الصفحة إن كان قائمًا
(function initBanOnLoad(){
  if(Date.now() < banUntil){
    setBannedState(true);
    startCountdown(banUntil);
  } else if (banUntil){
    clearBan();
  }
})();

// ابدأ فحص الدخول التلقائي
autoRedirectOrShowMsg();
</script>

<script src="login.js"></script>
<script src="scriptblock.js"></script>
</body>
</html>
